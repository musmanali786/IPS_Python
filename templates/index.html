<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graph Plotter</title>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #graph-container {
            position: relative; /* Ensure the container is a positioning context */
            /*width: 800px; !* Or whatever size you want *!*/
            /*height: 600px; !* Or whatever size you want *!*/
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden; /* Clip the image */
        }
        #graph-image {
            display: block; /* Removes extra space below the image */
            max-width: 100%; /* Ensure image doesn't overflow container */
            height: auto;    /* Maintain aspect ratio */
        }
        #point-canvas {
            position: absolute; /* Allows overlaying the image */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }
         .point {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: red;
            position: absolute;
            transform: translate(-50%, -50%); /* Center the point */
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-6">
        <h1 class="text-2xl font-semibold text-gray-800 mb-8">Graph Plotter</h1>

        <form id="upload-form" action="/" method="post" enctype="multipart/form-data" class="mb-8 bg-white p-6 rounded-lg shadow-md">
            <div class="mb-4">
                <label for="image" class="block text-gray-700 text-sm font-bold mb-2">Upload Graph Image:</label>
                <input type="file" name="image" id="image" accept="image/*" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Upload</button>
        </form>

        <% if image_filename: %>
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Select Points on the Graph:</h2>
                <div id="graph-container" class="relative">
                    <img id="graph-image" src="/uploads/<%= image_filename %>" alt="Graph Image">
                     <canvas id="point-canvas"></canvas>
                </div>
                 <div id="points-list" class="mt-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Selected Points:</h3>
                    <ul id="points-display" class="border rounded p-2 bg-gray-50 h-48 overflow-y-auto">
                         <% points.forEach(function(point) { %>
                           <li>( <%= point.x.toFixed(2) %> , <%= point.y.toFixed(2) %>)</li>
                        <% }); %>
                    </ul>
                </div>
            </div>

            <form id="pdf-form" action="/generate_pdf" method="post" class="bg-white p-6 rounded-lg shadow-md">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="x_label" class="block text-gray-700 text-sm font-bold mb-2">Horizontal Axis Label:</label>
                        <input type="text" name="x_label" id="x_label" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="y_label" class="block text-gray-700 text-sm font-bold mb-2">Vertical Axis Label:</label>
                        <input type="text" name="y_label" id="y_label" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="x_start" class="block text-gray-700 text-sm font-bold mb-2">Horizontal Axis Start:</label>
                        <input type="text" name="x_start" id="x_start"  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="x_end" class="block text-gray-700 text-sm font-bold mb-2">Horizontal Axis End:</label>
                        <input type="text" name="x_end" id="x_end" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="y_start" class="block text-gray-700 text-sm font-bold mb-2">Vertical Axis Start:</label>
                        <input type="text" name="y_start" id="y_start"  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="y_end" class="block text-gray-700 text-sm font-bold mb-2">Vertical Axis End:</label>
                        <input type="text" name="y_end" id="y_end" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                </div>
                <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Generate PDF</button>
            </form>
        <% endif %>
    </div>

    <script>
        const canvas = document.getElementById('point-canvas');
        const ctx = canvas.getContext('2d');
        const image = document.getElementById('graph-image');
        const pointsDisplay = document.getElementById('points-display');
        const form = document.getElementById('pdf-form');

        let points = []; // Local point storage

        function resizeCanvas() {
            canvas.width = image.offsetWidth;
            canvas.height = image.offsetHeight;
        }

        image.onload = () => {
            resizeCanvas();
        };
        window.addEventListener('resize', resizeCanvas);


        canvas.addEventListener('click', (event) => {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            addPoint(x, y); // Add point to local array and display
            sendPointToServer(x, y); // Send point to server
        });

        function drawPoints() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas
            points.forEach(point => {
                ctx.beginPath();
                ctx.arc(point.x, point.y, 5, 0, 2 * Math.PI);
                ctx.fillStyle = 'red';
                ctx.fill();
                ctx.closePath();
            });
        }

        function addPoint(x, y) {
            points.push({ x: x, y: y });
            drawPoints();
            const li = document.createElement('li');
            li.textContent = `(${x.toFixed(2)}, ${y.toFixed(2)})`;
            pointsDisplay.appendChild(li);
        }

        function sendPointToServer(x, y) {
            fetch('/add_point', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `x=${x}&y=${y}`,
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                   // console.log('Point added on server:', x, y);
                } else {
                    console.error('Failed to add point:', data.message);
                }
            })
            .catch(error => {
                console.error('Error sending point:', error);
            });
        }

        function getPointsFromServer() {
            fetch('/get_points', {
                method: 'GET',
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.points) {
                    points = data.points; //get points from server.
                    drawPoints(); //draw the points.
                    pointsDisplay.innerHTML = ''; // Clear old display
                     points.forEach(point => {
                        const li = document.createElement('li');
                        li.textContent = `(${point.x.toFixed(2)}, ${point.y.toFixed(2)})`;
                        pointsDisplay.appendChild(li);
                    });
                }
            })
            .catch(error => {
                console.error('Error getting points:', error);
            });
        }
        getPointsFromServer(); //get points on page load.

        if (form) {
            form.addEventListener('submit', (event) => {
                event.preventDefault();

                const formData = new FormData(form);

                fetch('/generate_pdf', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(new Blob([blob]));
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'graph.pdf';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    // Clear the points after successful PDF generation
                    points = [];
                    drawPoints();
                    pointsDisplay.innerHTML = '';
                })
                .catch(error => {
                    console.error('Error generating PDF:', error);
                });
            });
        }
    </script>
</body>
</html>
